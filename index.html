<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>MCQ App</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f1f5f9;
            --border: #334155;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; transition: background 0.3s; }
        body { background-color: var(--bg); margin: 0; padding: 20px; color: var(--text); overflow-x: hidden; }
        .container { max-width: 900px; margin: 0 auto; }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¸Ù‡ÙˆØ± (Fade-in) */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in { animation: fadeIn 0.6s ease forwards; }

        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 2px solid var(--border);
            border-right: 8px solid var(--border);
            transition: all 0.3s ease;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø¨ Ø¹Ù„ÙŠÙ‡ */
        .card.is-answered {
            border-color: var(--primary) !important;
            border-right: 8px solid var(--primary) !important;
            background-color: rgba(37, 99, 235, 0.08) !important;
        }

        .card.correct { border-color: var(--success) !important; background: rgba(22, 163, 74, 0.1) !important; }
        .card.wrong { border-color: var(--danger) !important; background: rgba(220, 38, 38, 0.1) !important; }

        header {
            position: sticky; top: 0; z-index: 100;
            background: var(--card-bg);
            padding: 15px; border-bottom: 3px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center; border-radius: 0 0 10px 10px;
        }

        .choice-item {
            display: flex; align-items: center; padding: 12px;
            border: 1px solid var(--border); border-radius: 8px; cursor: pointer; margin-top: 8px;
        }
        .choice-item:hover { background: rgba(37, 99, 235, 0.05); }

        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); padding: 10px; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%; }
        .hidden { display: none !important; }

        #history-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 600px; padding: 25px; border-radius: 15px; position: relative; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <button onclick="toggleTheme()" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;">ğŸŒ“</button>
    </div>

    <div id="setup-view" class="card fade-in">
        <h1 style="text-align: center; color: var(--primary);">Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„ÙŠØ© Ø§Ù„ØªÙ‚ØµÙŠØ±ÙŠØ©</h1>
        <div style="margin: 20px 0;">
            <label>Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
            <select id="q-count" onchange="checkShuffle()" style="width: 100%; padding: 12px; border-radius: 8px;">
                <option value="25">25 Ø³Ø¤Ø§Ù„</option>
                <option value="50">50 Ø³Ø¤Ø§Ù„</option>
                <option value="75">75 Ø³Ø¤Ø§Ù„</option>
                <option value="100">100 Ø³Ø¤Ø§Ù„</option>
                <option value="150">150 Ø³Ø¤Ø§Ù„</option>
                <option value="200">200 Ø³Ø¤Ø§Ù„ (Ø§Ù„ÙƒÙ„)</option>
            </select>
        </div>
        <div id="shuffle-container" class="hidden" style="margin-bottom: 15px;">
            <input type="checkbox" id="q-shuffle" checked> ØªØ±ØªÙŠØ¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„ÙƒÙ„
        </div>
        <button class="btn-primary" onclick="startQuiz()">Ø§Ø¨Ø¯Ø£ Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn-outline" onclick="showHistory()">Ø³Ø¬Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</button>
    </div>

    <div id="quiz-view" class="hidden">
        <header class="card">
            <div id="timer" style="font-family: monospace; font-weight: bold; font-size: 1.2rem;">00:00:00</div>
            <div id="progress">Ø³Ø¤Ø§Ù„ 1</div>
            <button onclick="finishQuiz()" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">ØªØ³Ù„ÙŠÙ…</button>
        </header>
        <div id="questions-list" style="margin-top: 20px;"></div>
    </div>
    <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'})" 
        style="position:fixed; bottom:20px; left:20px; display:none; background:var(--primary); color:white; border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; z-index:1000; font-size:20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">â†‘</button>
<button id="autoSolveBtn" onclick="askForPassword()" class="hidden" 
        style="position:fixed; bottom:20px; right:20px; background:var(--primary); opacity: 0.6; color:white; border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; z-index:1000; font-size:20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">ğŸ”‘</button>
    <div id="filter-buttons" class="hidden" style="margin: 20px 0; display: flex; gap: 10px; justify-content: center;">
        <button class="btn-outline" onclick="filterReview('all')" style="width: auto; padding: 5px 15px;">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
        <button class="btn-outline" onclick="filterReview('wrong')" style="width: auto; padding: 5px 15px; color: var(--danger); border-color: var(--danger);">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙ‚Ø· âŒ</button>
    </div>

<div id="result-view" class="hidden">
    <div class="card fade-in" style="text-align: center; border-right: none;">
        <h2 id="final-score" style="font-size: 3rem; color: var(--primary); margin: 0;">0 / 0</h2>
        <p id="result-msg" style="font-weight: bold;"></p>
        
        <div id="filter-buttons" style="margin: 20px 0; display: flex; gap: 10px; justify-content: center;">
<button class="btn-outline" onclick="filterReview('all')" style="width: auto; padding: 8px 20px;">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
    <button class="btn-outline" onclick="filterReview('correct')" style="width: auto; padding: 8px 20px; color: var(--success); border-color: var(--success);">Ø§Ù„ØµØ­ ÙÙ‚Ø· âœ…</button>
    <button class="btn-outline" onclick="filterReview('wrong')" style="width: auto; padding: 8px 20px; color: var(--danger); border-color: var(--danger);">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙ‚Ø· âŒ</button>        </div>

        <button class="btn-primary" style="max-width: 250px;" onclick="clearActiveAndReload()">Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div id="review-list"></div>
</div>
    <div id="stats-section" class="card hidden fade-in">
    <h3>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ ğŸ“Š</h3>
    <canvas id="performanceChart"></canvas>
    <div id="time-stats" style="margin-top: 15px; font-weight: bold; color: var(--primary); text-align: center;"></div>
</div>
</div>

<div id="history-modal" onclick="if(event.target==this) closeHistory()">
    <div class="modal-content card">
        <h3>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚</h3>
        <div id="history-list" style="max-height: 400px; overflow-y: auto;"></div>
        <button class="btn-outline" onclick="closeHistory()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
let allData = [];
let currentQuiz = [];
let userAnswers = {};
let timer;
let timeLeft;

// 1. ØªØ´ØºÙŠÙ„ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function init() {
    try {
        const res = await fetch('Questions.json');
        const data = await res.json();
        allData = data.questions;
    } catch(e) { alert("ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Questions.json"); }
    
    if(localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');

    const active = localStorage.getItem('active_quiz_v4');
    if(active) {
        if(confirm("ÙˆØ¬Ø¯Ù†Ø§ Ø§Ù…ØªØ­Ø§Ù†Ø§Ù‹ Ù„Ù… ÙŠÙƒØªÙ…Ù„ØŒ Ù‡Ù„ ØªÙˆØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„ÙŠÙ‡ØŸ")) {
            resumeQuiz(JSON.parse(active));
            document.getElementById('autoSolveBtn').classList.remove('hidden');
            return;
        } else { localStorage.removeItem('active_quiz_v4'); }
    }
}

function checkShuffle() {
    const count = document.getElementById('q-count').value;
    document.getElementById('shuffle-container').classList.toggle('hidden', count >= '201');
}


const hashedPassword = "0559aadba9e29b9a271ec93982f3273575085931938fdbf940ae99f8bb128e30";

async function askForPassword() {
    const userInput = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:");
    if (!userInput) return;

    // ØªØ­ÙˆÙŠÙ„ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø¨ØµÙ…Ø© Ø±Ù‚Ù…ÙŠØ© Ù„Ù…Ù‚Ø§Ø±Ù†ØªÙ‡Ø§
    const buffer = new TextEncoder().encode(userInput);
    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const userHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

    if (userHash === hashedPassword) {
        autoSolve();
        alert("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚.. Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ù…ØµØ·ÙÙ‰! ğŸš€ ØªÙ… Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙŠØ§ Ù…ØµØ·ÙÙ‰ Ø¨ÙŠÙ‡!");
    } else {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©! Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØºØ´ Ù‡Ù†Ø§ ğŸ˜‰");
    }
}

function autoSolve() {
    currentQuiz.forEach((q, i) => {
        // 1. ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙŠ Ù…ØµÙÙˆÙØ© Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        userAnswers[i] = q.correctAnswer;
        
        // 2. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ Ø¨ÙˆØªÙˆÙ† (Radio Button) ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const radio = document.querySelector(`input[name="q${i}"][value="${q.correctAnswer}"]`);
        if (radio) {
            radio.checked = true;
        }
        
        // 3. ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„ÙƒØ§Ø±Øª Ù„ÙŠØµØ¨Ø­ "Ù…Ø¬Ø§Ø¨ Ø¹Ù„ÙŠÙ‡"
        const card = document.getElementById(`card-${i}`);
        if (card) {
            card.classList.add('is-answered');
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ
    document.getElementById('progress').innerText = `ØªÙ… Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (${currentQuiz.length})`;
    
    // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ù„ÙƒÙŠ Ù„Ø§ ÙŠØ¶ÙŠØ¹ Ø¥Ø°Ø§ Ø£ØºÙ„Ù‚Øª Ø§Ù„ØµÙØ­Ø©
    saveProgress();
}

function filterReview(type) {
    const cards = document.querySelectorAll('#review-list .card');
    
    cards.forEach(card => {
        if (type === 'all') {
            card.classList.remove('hidden');
        } 
        else if (type === 'correct') {
            // Ù„Ùˆ Ø§Ø®ØªØ±Ù†Ø§ "ØµØ­ ÙÙ‚Ø·"ØŒ Ù†Ø®ÙÙŠ Ø£ÙŠ ÙƒØ§Ø±Øª ÙÙŠÙ‡ ÙƒÙ„Ø§Ø³ wrong
            card.classList.contains('wrong') ? card.classList.add('hidden') : card.classList.remove('hidden');
        } 
        else if (type === 'wrong') {
            // Ù„Ùˆ Ø§Ø®ØªØ±Ù†Ø§ "Ø®Ø·Ø£ ÙÙ‚Ø·"ØŒ Ù†Ø®ÙÙŠ Ø£ÙŠ ÙƒØ§Ø±Øª ÙÙŠÙ‡ ÙƒÙ„Ø§Ø³ correct
            card.classList.contains('correct') ? card.classList.add('hidden') : card.classList.remove('hidden');
        }
    });
}
// 2. Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
function startQuiz() {
    const count = parseInt(document.getElementById('q-count').value);
    const shuffle = document.getElementById('q-shuffle').checked;
    
    let pool = [...allData];
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø± 200 Ø£Ùˆ Ø£Ù‚Ù„ØŒ Ù†Ø£Ø®Ø° Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ø£Ùˆ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
    if (shuffle) {
        pool.sort(() => Math.random() - 0.5);
    }

    document.getElementById('autoSolveBtn').classList.remove('hidden');
    
    currentQuiz = pool.slice(0, count);
    userAnswers = {};
    
    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø¯Ù‚ÙŠÙ‚Ø© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ Ù…Ø«Ù„Ø§Ù‹)
    timeLeft = count * 60; 
    
    renderAndStart();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
    window.onscroll = function() {
        document.getElementById('backToTop').style.display = window.scrollY > 500 ? 'block' : 'none';
    };
}

function resumeQuiz(data) {
    currentQuiz = data.quiz;
    userAnswers = data.answers || {};
    timeLeft = data.timeLeft;
    renderAndStart();
}

function renderAndStart() {
    document.getElementById('setup-view').classList.add('hidden');
    document.getElementById('quiz-view').classList.remove('hidden');
    renderQuestions();
    startTimer();
}

// 3. Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ± Fade-in
function renderQuestions() {
    const container = document.getElementById('questions-list');
    container.innerHTML = '';
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… DocumentFragment Ù„ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ù‚Ù† ÙÙŠ Ø§Ù„Ù€ HTML
    const fragment = document.createDocumentFragment();
    
    currentQuiz.forEach((q, i) => {
        const card = document.createElement('div');
        card.id = `card-${i}`;
        // ÙÙ‚Ø· Ø£ÙˆÙ„ 30 Ø³Ø¤Ø§Ù„ ÙŠØ£Ø®Ø°ÙˆÙ† ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ Ù„ØªÙˆÙÙŠØ± Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…ØªØµÙØ­
        card.className = `card ${i < 30 ? 'fade-in' : ''} ${userAnswers[i] ? 'is-answered' : ''}`;
        if(i < 30) card.style.animationDelay = `${i * 0.05}s`;
        
        card.innerHTML = `
            <p><b>${i+1}.</b> ${q.question}</p>
            ${q.choices.map(c => `
                <label class="choice-item">
                    <input type="radio" name="q${i}" value="${c.key}" 
                    ${userAnswers[i] === c.key ? 'checked' : ''} 
                    onchange="markAnswered(${i}, '${c.key}')">
                    ${c.key}: ${c.text}
                </label>
            `).join('')}
        `;
        fragment.appendChild(card);
    });
    
    container.appendChild(fragment);
}

function markAnswered(idx, key) {
    userAnswers[idx] = key;
    document.getElementById(`card-${idx}`).classList.add('is-answered');
    document.getElementById('progress').innerText = `Ø³Ø¤Ø§Ù„ ${idx + 1} Ù…Ù† ${currentQuiz.length}`;
    saveProgress();
}

// 4. Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø³Ø¬Ù„
function saveProgress() {
    localStorage.setItem('active_quiz_v4', JSON.stringify({
        quiz: currentQuiz, answers: userAnswers, timeLeft: timeLeft
    }));
}

function finishQuiz() {
    clearInterval(timer);
    localStorage.removeItem('active_quiz_v4');
    
    let score = 0;
    currentQuiz.forEach((q, i) => { if(userAnswers[i] === q.correctAnswer) score++; });
    document.getElementById('autoSolveBtn').classList.add('hidden');
    saveToHistory(score, currentQuiz.length);
    showResults(score);
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
function showResults(score) {
    document.getElementById('quiz-view').classList.add('hidden');
    document.getElementById('setup-view').classList.add('hidden'); // ØªØ£ÙƒÙŠØ¯ Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
    document.getElementById('result-view').classList.remove('hidden');
    document.getElementById('stats-section').classList.remove('hidden'); 
    
    document.getElementById('final-score').innerText = `${score} / ${currentQuiz.length}`;
    
    updateChart(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
    renderReview(); // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù†Ø§Ù‚ØµØ©)
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function renderReview() {
    const review = document.getElementById('review-list');
    review.innerHTML = '<h3 class="fade-in" style="margin-top:30px;">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ğŸ“</h3>';
    
    currentQuiz.forEach((q, i) => {
        const isCorrect = userAnswers[i] === q.correctAnswer;
        const card = document.createElement('div');
        card.className = `card fade-in ${isCorrect ? 'correct' : 'wrong'}`;
        card.style.animationDelay = `${i * 0.05}s`;
        
        card.innerHTML = `
            <p><b>Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}:</b> ${q.question}</p>
            <p style="margin-bottom:5px;">
                <b>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</b> <span style="color:${isCorrect ? 'var(--success)' : 'var(--danger)'}">
                    ${userAnswers[i] || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©'}
                </span>
            </p>
            ${!isCorrect ? `<p><b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</b> <span style="color:var(--success)">${q.correctAnswer}</span></p>` : ''}
        `;
        review.appendChild(card);
    });
}

// Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
function updateChart() {
    const history = JSON.parse(localStorage.getItem('quiz_history_v4') || '[]');
    if (history.length === 0) return;

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¢Ø®Ø± 10 Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ø«Ù„Ø§Ù‹)
    const lastExams = history.slice(0, 10).reverse();
    const labels = lastExams.map(h => h.date.split(',')[0]); // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
    const scores = lastExams.map(h => (h.score / h.total) * 100);

    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø³Ù… Ù‚Ø¯ÙŠÙ… Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø³Ø­Ù‡ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
    if (window.myChart) window.myChart.destroy();

    window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ %',
                data: scores,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                fill: true,
                tension: 0.4 // Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù…Ù†Ø­Ù†Ù‰ Ù†Ø§Ø¹Ù…
            }]
        },
        options: {
            scales: { y: { beginAtZero: true, max: 100 } }
        }
    });

    // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆÙ‚Øª Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø­ØªØ§Ø¬ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ (Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø£ØµÙ„ÙŠ - Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ)
    const totalTimeSpent = (120 * 60) - timeLeft;
    const avgPerQuestion = (totalTimeSpent / currentQuiz.length).toFixed(1);
    document.getElementById('time-stats').innerText = `â±ï¸ Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø­Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†: ${avgPerQuestion} Ø«Ø§Ù†ÙŠØ©`;
}

function saveToHistory(score, total) {
    const history = JSON.parse(localStorage.getItem('quiz_history_v4') || '[]');
    const timeSpent = (120 * 60) - timeLeft; // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø°ÙŠ Ø§Ø³ØªØºØ±Ù‚Ù‡ Ø§Ù„Ø·Ø§Ù„Ø¨
    
    history.unshift({ 
        id: Date.now(), 
        date: new Date().toLocaleString('ar-EG'), 
        score, 
        total, 
        quiz: currentQuiz, 
        answers: userAnswers,
        timeSpent: timeSpent 
    });
    localStorage.setItem('quiz_history_v4', JSON.stringify(history));
}

function showHistory() {
    const history = JSON.parse(localStorage.getItem('quiz_history_v4') || '[]');
    document.getElementById('history-modal').style.display = 'flex';
    document.getElementById('history-list').innerHTML = history.map(h => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid var(--border);">
            <div onclick="viewOld(${h.id})" style="cursor:pointer; flex-grow:1;">
                <b>${h.date}</b> <br> <small>Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${h.score}/${h.total}</small>
            </div>
            <button onclick="deleteEntry(${h.id})" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1.2rem;">ğŸ—‘ï¸</button>
        </div>
    `).join('') || 'Ø§Ù„Ø³Ø¬Ù„ ÙØ§Ø±Øº.';
}

function viewOld(id) {
    const history = JSON.parse(localStorage.getItem('quiz_history_v4') || '[]');
    const h = history.find(item => item.id === id);
    
    if (h) {
        userAnswers = h.answers;
        currentQuiz = h.quiz;
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„ÙŠÙƒÙˆÙ† 0 ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„ÙƒÙŠ Ù„Ø§ ÙŠØªØ£Ø«Ø± Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆÙ‚Øª
        timeLeft = (120 * 60) - (h.timeSpent || 0); 
        
        closeHistory();
        showResults(h.score);
    }
}

function deleteEntry(id) {
    let history = JSON.parse(localStorage.getItem('quiz_history_v4')).filter(h => h.id !== id);
    localStorage.setItem('quiz_history_v4', JSON.stringify(history));
    showHistory();
}

function startTimer() {
    timer = setInterval(() => {
        timeLeft--;
        if(timeLeft % 5 === 0) saveProgress();
        const h = Math.floor(timeLeft/3600), m = Math.floor((timeLeft%3600)/60), s = timeLeft%60;
        document.getElementById('timer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        if(timeLeft <= 0) finishQuiz();
    }, 1000);
}

function toggleTheme() {
    const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
}

function closeHistory() { document.getElementById('history-modal').style.display = 'none'; }
function clearActiveAndReload() {
    localStorage.removeItem('active_quiz_v4');
    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ ÙˆØ¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    document.getElementById('result-view').classList.add('hidden');
    document.getElementById('stats-section').classList.add('hidden');
    document.getElementById('setup-view').classList.remove('hidden');
    window.location.reload(); 
}
init();
</script>
</body>
</html>
